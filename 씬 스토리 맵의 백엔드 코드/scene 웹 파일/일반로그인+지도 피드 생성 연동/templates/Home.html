<!DOCTYPE html>
<!-- HTML5 ë¬¸ì„œ íƒ€ì… ì„ ì–¸ -->
<html lang="ko">
<!-- ë¬¸ì„œì˜ ì–¸ì–´ë¥¼ í•œêµ­ì–´ë¡œ ì„¤ì • -->

<head>
  <meta charset="UTF-8" />
  <!-- ë¬¸ì ì¸ì½”ë”©ì„ UTF-8ë¡œ ì„¤ì • -->

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- ë°˜ì‘í˜• ë””ìì¸ì„ ìœ„í•´ í™”ë©´ ë„ˆë¹„ì— ë”°ë¼ ì½˜í…ì¸  í¬ê¸° ì¡°ì ˆ -->

  <title>ì§€ë„ ê²€ìƒ‰ ê¸°ëŠ¥ + í”¼ë“œ ì €ì¥</title>
  <!-- ë¸Œë¼ìš°ì € íƒ­ì— í‘œì‹œë  ë¬¸ì„œ ì œëª© -->

  <style>
    html, body {
      margin: 0;
      height: 100%;
    }
    /* ë¸Œë¼ìš°ì € ê¸°ë³¸ ì—¬ë°± ì œê±°, ì „ì²´ ë†’ì´ë¥¼ 100%ë¡œ ì„¤ì • */

    #map {
      width: 100%;
      height: 100%;
    }
    /* ì§€ë„ divë¥¼ í™”ë©´ ì „ì²´ë¡œ ì„¤ì • */

    #search-container {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: white;
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: flex;
      gap: 8px;
    }
    /* ê²€ìƒ‰ì°½ ìŠ¤íƒ€ì¼ë§: ìƒë‹¨ ì¤‘ì•™ ê³ ì •, í°ìƒ‰ ë°°ê²½, ê·¸ë¦¼ì ë° ë¼ìš´ë“œ ì²˜ë¦¬ */

    #search-input {
      padding: 6px;
      font-size: 14px;
      width: 200px;
    }
    /* ê²€ìƒ‰ ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */

    #search-btn {
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
    }
    /* ê²€ìƒ‰ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  </style>
</head>

<body>
  <!-- í˜ì´ì§€ ë³¸ë¬¸ ì‹œì‘ -->

  <div id="search-container">
    <!-- ê²€ìƒ‰ì°½ UI ì»¨í…Œì´ë„ˆ -->
    <input type="text" id="search-input" placeholder="ì§€ì—­ëª… ì…ë ¥ (ì˜ˆ: ê°•ë‚¨êµ¬)" />
    <!-- ì§€ì—­ëª…ì„ ì…ë ¥í•  í…ìŠ¤íŠ¸ í•„ë“œ -->
    <button id="search-btn">ì´ë™</button>
    <!-- ì§€ë„ ì´ë™ ë²„íŠ¼ -->
  </div>

  <!-- feed ëª¨ë‹¬ -->
<div id="feed-modal" style="
    display:none;
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    max-width: 600px;
    max-height: 70%;
    overflow-y: auto;
    background: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    z-index: 10000;
    padding: 20px;
">
  <button id="feed-modal-close" style="float:right; font-size: 20px; cursor:pointer;">&times;</button>
  <div id="feed-modal-content">
    <!-- AJAXë¡œ ë°›ì•„ì˜¨ feed.html ë‚´ìš©ì´ ì—¬ê¸° ë“¤ì–´ê°‘ë‹ˆë‹¤ -->
  </div>
</div>

  <!-- íšŒì›ê°€ì… ë° ë¡œê·¸ì¸ ë²„íŠ¼ -->
  <form action="{{ url_for('index1') }}">
  <button id="profile-button" type="submit" style="z-index:999">íšŒì›ê°€ì… ë° ë¡œê·¸ì¸.
  </button>
</form>

<!-- í”„ë¡œí•„ ì°½ìœ¼ë¡œ ì´ë™í•˜ëŠ” ë²„íŠ¼ -->
<form action="{{ url_for('profile') }}" method="get" style="position: fixed; top: 10px; right: 10px; margin: 0; z-index: 9999;">
  <button type="submit"
      style="
          background-image: url('{{ url_for('static', filename=profile_img_url) }}');
          background-size: cover;
          background-position: center;
          border: none;
          border-radius: 50%;
          width: 60px;
          height: 60px;
          cursor: pointer;
      ">
  </button>
</form>

  <div id="map"></div>
  <!-- ì§€ë„ë¥¼ í‘œì‹œí•  div ìš”ì†Œ -->

  <script>
    // ì§€ë„ ìŠ¤íƒ€ì¼ ì„¤ì • (ë²„ìŠ¤ ì •ë¥˜ì¥ ìˆ¨ê¸°ê¸°)
    const mapStyles = [
      { featureType: "transit.station.bus", stylers: [{ visibility: "off" }] }
    ];

    const fallbackPosition = { lat: 37.5665, lng: 126.9780 };
    // ìœ„ì¹˜ ê¶Œí•œ ê±°ë¶€ ì‹œ ê¸°ë³¸ ìœ„ì¹˜ (ì„œìš¸ ì‹œì²­ ì¢Œí‘œ)

    let map; // ì „ì—­ ë³€ìˆ˜: Google ì§€ë„ ê°ì²´
    const markers = []; // ìƒì„±ëœ ë§ˆì»¤ë“¤ì„ ì €ì¥í•  ë°°ì—´

    // Google Maps API ë¡œë“œ í›„ ì‹¤í–‰ë  ì½œë°± í•¨ìˆ˜
    window.initMap = function () {
      // ì§€ë„ ì´ˆê¸°í™”
      map = new google.maps.Map(document.getElementById("map"), {
        center: fallbackPosition,
        zoom: 16,
        disableDefaultUI: true,  // ê¸°ë³¸ UI ì œê±°
        zoomControl: true,       // ì¤Œ ì»¨íŠ¸ë¡¤ë§Œ í™œì„±í™”
        styles: mapStyles,       // ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ ì ìš©
      });

      // ë¸Œë¼ìš°ì € ìœ„ì¹˜ ì •ë³´ ì ‘ê·¼
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          ({ coords }) => {
            const pos = { lat: coords.latitude, lng: coords.longitude };
            map.setCenter(pos);  // í˜„ì¬ ìœ„ì¹˜ë¡œ ì§€ë„ ì´ë™
            console.log("ğŸ“ ì‚¬ìš©ì ìœ„ì¹˜ë¡œ ì§€ë„ ì´ë™:", pos);
          },
          () => console.warn("âš ï¸ ìœ„ì¹˜ ê¶Œí•œ ê±°ë¶€ë¨, fallback ìœ„ì¹˜ ì‚¬ìš©")
        );
      }

      setupSearch();       // ê²€ìƒ‰ ê¸°ëŠ¥ ì´ˆê¸°í™”
      loadExistingFeeds(); // ì €ì¥ëœ í”¼ë“œ ë¶ˆëŸ¬ì˜¤ê¸°

      // ì§€ë„ì—ì„œ ë§ˆìš°ìŠ¤ ì˜¤ë¥¸ìª½ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì²˜ë¦¬
      map.addListener("rightclick", function (event) {
  const lat = event.latLng.lat();
  const lng = event.latLng.lng();

  // ë§ˆì»¤ ìƒì„±
  const marker = new google.maps.Marker({
    position: { lat, lng },
    map: map,
    icon: {
      url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
    }
  });
  markers.push(marker); // ë§ˆì»¤ ë°°ì—´ì— ì €ì¥

  // ëª¨ë‹¬ HTML ë¶ˆëŸ¬ì˜¤ê¸°
  fetch("/feed_modal_form")
    .then(res => res.text())
    .then(html => {
      document.getElementById("feed-modal-content").innerHTML = html;
      document.getElementById("feed-modal").style.display = "block";

      // ìœ„ë„, ê²½ë„ í¼ì— ìë™ ì…ë ¥
      document.getElementById("form-lat").value = lat;
      document.getElementById("form-lng").value = lng;

      // í¼ submit ì´ë²¤íŠ¸ ì—°ê²°
      document.getElementById("feed-form").addEventListener("submit", function (e) {
        e.preventDefault();

        const formData = new FormData(this);

        fetch("/add_feed_full", {
          method: "POST",
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert("âœ… í”¼ë“œ ì €ì¥ ì™„ë£Œ!");

            const imgDiv = document.getElementById("uploaded-images");
            imgDiv.innerHTML = "";  // ì´ˆê¸°í™”
            data.image_urls.forEach(url => {
              const img = document.createElement("img");
              img.src = url;
              img.style.height = "100px";
              imgDiv.appendChild(img);
            });
          } else {
            alert("âŒ ì‹¤íŒ¨: " + data.message);
          }
        })
        .catch(err => {
          alert("âŒ ì—ëŸ¬ ë°œìƒ: " + err);
        });
      });
    });
});

// ë‹«ê¸° ë²„íŠ¼
document.getElementById("feed-modal-close").addEventListener("click", () => {
  document.getElementById("feed-modal").style.display = "none";
});
}

    // ê²€ìƒ‰ì°½ ì…ë ¥ ë° ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì •
    const setupSearch = () => {
      const input = document.getElementById("search-input");
      const button = document.getElementById("search-btn");
      const geocoder = new google.maps.Geocoder(); // ì£¼ì†Œë¥¼ ì¢Œí‘œë¡œ ë³€í™˜í•˜ëŠ” ê°ì²´

      // ê²€ìƒ‰ ì‹¤í–‰ í•¨ìˆ˜
      const handleSearch = () => {
        const query = input.value.trim();
        if (!query) return;

        // ì£¼ì†Œ -> ì¢Œí‘œ ë³€í™˜ ìš”ì²­
        geocoder.geocode({ address: query }, (results, status) => {
          if (status === "OK" && results.length > 0) {
            const location = results[0].geometry.location;
            map.setCenter(location); // ê²€ìƒ‰ëœ ìœ„ì¹˜ë¡œ ì§€ë„ ì´ë™
            console.log("ğŸ” ê²€ìƒ‰ ìœ„ì¹˜ ì´ë™:", location.toJSON());
          } else {
            alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
            console.warn("âŒ Geocoding ì‹¤íŒ¨:", status);
          }
        });
      };

      button.onclick = handleSearch;  // ë²„íŠ¼ í´ë¦­ ì‹œ ê²€ìƒ‰ ì‹¤í–‰
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") handleSearch(); // ì—”í„° ì…ë ¥ ì‹œ ê²€ìƒ‰ ì‹¤í–‰
      });
    };

    const addMarker = ({ lat, lng }) => {
  const marker = new google.maps.Marker({
    position: { lat, lng },
    map: map,
    icon: {
      url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
    }
  });
  markers.push(marker);

  // ë§ˆì»¤ í´ë¦­ ì‹œ ê¸°ì¡´ í”¼ë“œ ìˆ˜ì • í¼ ë„ìš°ê¸°
// ë§ˆì»¤ í´ë¦­ ì‹œ ê¸°ì¡´ í”¼ë“œ ìˆ˜ì • í¼ ë„ìš°ê¸°
marker.addListener("click", () => {
  const lat = marker.getPosition().lat();
  const lng = marker.getPosition().lng();

  // 1. ë¨¼ì € í•´ë‹¹ ìœ„ì¹˜ì— ìˆëŠ” feed_idë¥¼ ê°€ì ¸ì˜¨ë‹¤
  fetch(`/get_feed_data_by_coords?lat=${lat}&lng=${lng}`)
    .then(res => res.json())
    .then(data => {
      if (!data.success) {
        alert("âŒ í”¼ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const feedData = data.feed;
      const feed_id = feedData.feed_id;
      const feed_intro = feedData.feed_introduction;

      // 2. í”¼ë“œ ëª¨ë‹¬ í¼ì„ ë¶ˆëŸ¬ì˜¨ë‹¤
      fetch("/feed_modal_form")
        .then(res => res.text())
        .then(html => {
          document.getElementById("feed-modal-content").innerHTML = html;
          document.getElementById("feed-modal").style.display = "block";

          // 3. ê¸°ì¡´ ì •ë³´ ì±„ì›Œë„£ê¸°
          document.getElementById("form-lat").value = lat;
          document.getElementById("form-lng").value = lng;
          document.getElementById("feed-intro").value = feed_intro;

          // 4. submit ì´ë²¤íŠ¸ ìˆ˜ì • ìš”ì²­ìœ¼ë¡œ ë³´ëƒ„
          document.getElementById("feed-form").addEventListener("submit", function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            formData.append("feed_id", feed_id);  // í•„ìˆ˜

            fetch("/update_feed_full", {
              method: "POST",
              body: formData
            })
              .then(res => res.json())
              .then(result => {
                if (result.success) {
                  alert("âœ… í”¼ë“œ ìˆ˜ì • ì™„ë£Œ!");

                  const imgDiv = document.getElementById("uploaded-images");
                  imgDiv.innerHTML = "";
                  result.image_urls.forEach(url => {
                    const img = document.createElement("img");
                    img.src = url;
                    img.style.height = "100px";
                    imgDiv.appendChild(img);
                  });
                } else {
                  alert("âŒ ìˆ˜ì • ì‹¤íŒ¨: " + result.message);
                }
              })
              .catch(err => {
                alert("âŒ ì—ëŸ¬ ë°œìƒ: " + err);
              });
          });
        });
    });
})};

    // ì„œë²„ì—ì„œ ê¸°ì¡´ í”¼ë“œ ë¶ˆëŸ¬ì™€ ë§ˆì»¤ë¡œ í‘œì‹œ
    const loadExistingFeeds = () => {
      fetch("/get_feeds")
        .then(res => res.json())
        .then(data => {
          if (data.success && Array.isArray(data.feeds)) {
            data.feeds.forEach(feed => {
              addMarker({ lat: feed.lat, lng: feed.lng });
            });
          } else {
            console.warn("âŒ í”¼ë“œ ë¡œë”© ì‹¤íŒ¨ ë˜ëŠ” í˜•ì‹ ì˜¤ë¥˜");
          }
        })
        .catch(err => console.error("âŒ í”¼ë“œ ëª©ë¡ ìš”ì²­ ì‹¤íŒ¨:", err));
    };
    </script>

  <!-- Google Maps JavaScript APIë¥¼ ë¹„ë™ê¸°ë¡œ ë¶ˆëŸ¬ì˜¤ê³  initMap ì‹¤í–‰ -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBtqYND3hYOJxqadz5sbtHjxGbiuw-iCmI&callback=initMap">
  </script>
</body>
</html>